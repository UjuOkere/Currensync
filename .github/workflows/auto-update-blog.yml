name: Auto Update Blog

on:
  schedule:
    - cron: '0 * * * *'   # Runs every hour; adjust as needed
  workflow_dispatch:

jobs:
  update-blog:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      # 2. Set up Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml

      # 4. Diagnostics before running bot
      - name: List root & blog folders
        run: |
          echo "Root files:"
          ls -l
          echo "Blog folder:"
          ls -l blog
          echo "Blog posts folder:"
          ls -l blog/posts
          echo "Backups folder:"
          ls -l blog/backups

      # 5. Run bot
      - name: Run bot.py
        run: python bot.py

      # 6. Diagnostics after running bot
      - name: List blog posts and JSON
        run: |
          echo "Blog posts folder after bot run:"
          ls -l blog/posts
          echo "blogdata.json in root:"
          ls -l blogdata.json

      # 7. Commit new posts and blogdata.json
      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add blog/posts/*.html blogdata.json
          git diff --cached --exit-code || git commit -m "Auto-update blog posts and JSON"
          git push
